<!DOCTYPE html>
<html>
<head>
    <title>Test AI Extraction with Summary</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #0f0f1e;
            color: white;
        }
        h1 {
            color: #E94CFF;
            text-align: center;
        }
        .section {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(123, 63, 242, 0.3);
        }
        .success {
            color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #7B3FF2, #E94CFF);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        textarea {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(123, 63, 242, 0.5);
            color: white;
            border-radius: 5px;
            min-height: 200px;
            font-family: monospace;
        }
        .field {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }
        .field-label {
            font-weight: bold;
            color: #7B3FF2;
        }
        .field-value {
            color: #E94CFF;
        }
    </style>
</head>
<body>
    <h1>ü§ñ Test AI Extraction with Summary</h1>
    
    <div class="section">
        <h2>Sample Conversation</h2>
        <textarea id="conversation" placeholder="Enter a conversation to test extraction...">
[
  {"role": "assistant", "content": "Hello! I'm the AI consultant from Amplifyx Technologies. How can I help you with your AI project today?"},
  {"role": "user", "content": "Hi, I'm John Smith from TechCorp Industries. We're looking to implement an AI system for our customer service department."},
  {"role": "assistant", "content": "Great to meet you, John! AI for customer service is one of our specialties. Can you tell me more about the size of your customer service team and the volume of inquiries you handle?"},
  {"role": "user", "content": "We have about 50 agents handling around 10,000 tickets per month. We're hoping AI can help reduce response times and handle routine queries automatically."},
  {"role": "assistant", "content": "That's a perfect use case for AI automation. What's your timeline for implementing this solution?"},
  {"role": "user", "content": "We'd like to have something operational within the next 3 months. Our budget is around $75,000 for the initial implementation."},
  {"role": "assistant", "content": "That timeline and budget work well for this type of project. Could you share your email so I can send you a detailed proposal?"},
  {"role": "user", "content": "Sure, it's john.smith@techcorp.com and you can also reach me at 0412345678."}
]</textarea>
        <button onclick="testExtraction()">Test AI Extraction</button>
    </div>
    
    <div class="section">
        <h2>Extraction Results</h2>
        <div id="results"></div>
    </div>
    
    <div class="section">
        <h2>Supabase Submission</h2>
        <button onclick="submitToSupabase()" id="submitBtn" disabled>Submit to Supabase</button>
        <div id="submission-results"></div>
    </div>
    
    <script>
    // Load configuration
    const script = document.createElement('script');
    script.src = 'js/config-public.js';
    document.head.appendChild(script);
    
    let extractedData = null;
    let sessionId = 'test-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    
    async function testExtraction() {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="warning">‚è≥ Extracting data with AI...</div>';
        
        try {
            const conversation = JSON.parse(document.getElementById('conversation').value);
            
            // Create extraction prompt
            const extractionPrompt = `Extract the following information from this conversation. Return ONLY valid JSON with these exact fields (use null for missing values):
{
  "name": "full name of the person",
  "company": "company name",
  "email": "email address",
  "phone": "phone number",
  "projectType": "type of project they want",
  "timeline": "project timeline",
  "budget": "budget range",
  "summary": "2-3 sentence summary of the conversation and key requirements"
}

Conversation:
${conversation.map(msg => `${msg.role}: ${msg.content}`).join('\n')}`;
            
            // Call OpenAI API through proxy
            const apiUrl = window.AMPLIFYX_CONFIG?.apiProxyUrl || 'https://amplifyx-chatbot.vercel.app/api/chat';
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    messages: [
                        { role: 'system', content: 'You are a data extraction assistant. Extract structured data from conversations and return valid JSON only.' },
                        { role: 'user', content: extractionPrompt }
                    ],
                    model: 'gpt-4o',
                    temperature: 0.1,
                    max_tokens: 500
                })
            });
            
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }
            
            // Parse the extracted data
            extractedData = JSON.parse(data.choices[0].message.content);
            
            // Generate reference number
            extractedData.referenceNumber = 'AMP-' + Date.now().toString(36).toUpperCase();
            extractedData.score = 85; // High score for test
            extractedData.qualified = true;
            
            // Display results
            resultsDiv.innerHTML = `
                <div class="success">‚úÖ Successfully extracted data!</div>
                ${Object.entries(extractedData).map(([key, value]) => `
                    <div class="field">
                        <span class="field-label">${key}:</span>
                        <span class="field-value">${value || 'null'}</span>
                    </div>
                `).join('')}
                <h3>Raw JSON:</h3>
                <pre>${JSON.stringify(extractedData, null, 2)}</pre>
            `;
            
            // Enable submit button
            document.getElementById('submitBtn').disabled = false;
            
        } catch (error) {
            console.error('Extraction error:', error);
            resultsDiv.innerHTML = `
                <div class="error">‚ùå Extraction failed</div>
                <div class="error">${error.message}</div>
            `;
        }
    }
    
    async function submitToSupabase() {
        if (!extractedData) {
            alert('Please extract data first');
            return;
        }
        
        const resultsDiv = document.getElementById('submission-results');
        resultsDiv.innerHTML = '<div class="warning">‚è≥ Submitting to Supabase...</div>';
        
        try {
            const conversation = JSON.parse(document.getElementById('conversation').value);
            
            const submissionData = {
                sessionId: sessionId,
                structuredData: extractedData,
                conversation: conversation
            };
            
            const response = await fetch('https://amplifyx-chatbot.vercel.app/api/lead-submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Session-ID': sessionId
                },
                body: JSON.stringify(submissionData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                resultsDiv.innerHTML = `
                    <div class="success">‚úÖ Successfully submitted to Supabase!</div>
                    <div class="success">Lead ID: ${result.leadId}</div>
                    <div class="success">Reference: ${result.referenceNumber}</div>
                    <h3>Check Supabase for:</h3>
                    <ul style="color: #E94CFF;">
                        <li>Name: ${extractedData.name}</li>
                        <li>Email: ${extractedData.email}</li>
                        <li>Company: ${extractedData.company}</li>
                        <li>Summary: ${extractedData.summary}</li>
                    </ul>
                `;
            } else {
                resultsDiv.innerHTML = `
                    <div class="error">‚ùå Submission failed</div>
                    <div class="error">${result.error || 'Unknown error'}</div>
                `;
            }
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="error">‚ùå Network error</div>
                <div class="error">${error.message}</div>
            `;
        }
    }
    </script>
</body>
</html>