<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Integration</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #6d28d9; }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: white;
            border: 1px solid #ddd;
        }
        .success { border-color: #10b981; background: #f0fdf4; }
        .error { border-color: #ef4444; background: #fef2f2; }
        pre { 
            background: #1e293b; 
            color: #94a3b8; 
            padding: 10px; 
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üß™ Supabase Integration Test</h1>
    
    <div>
        <h2>1. Test Direct API</h2>
        <button onclick="testDirectAPI()">Send Test Lead to Supabase</button>
        <div id="api-result"></div>
    </div>

    <div>
        <h2>2. Test with Structured Data</h2>
        <button onclick="testWithStructuredData()">Test AI Response Processing</button>
        <div id="structured-result"></div>
    </div>

    <div>
        <h2>3. Manual Test Form</h2>
        <form id="test-form">
            <input type="text" id="name" placeholder="Name" required><br><br>
            <input type="email" id="email" placeholder="Email" required><br><br>
            <input type="tel" id="phone" placeholder="Phone"><br><br>
            <input type="text" id="company" placeholder="Company"><br><br>
            <input type="text" id="project" placeholder="Project Type"><br><br>
            <button type="submit">Submit to Supabase</button>
        </form>
        <div id="form-result"></div>
    </div>

    <script>
        async function testDirectAPI() {
            const resultDiv = document.getElementById('api-result');
            resultDiv.innerHTML = '<div class="result">Sending test lead...</div>';
            
            const testData = {
                sessionId: 'test-session-' + Date.now(),
                structuredData: {
                    name: 'Direct API Test',
                    email: 'direct@test.com',
                    phone: '+1234567890',
                    company: 'Test Company',
                    projectType: 'AI Integration',
                    timeline: 'Q1 2025',
                    budget: '$75,000',
                    score: 90
                },
                conversation: [
                    { role: 'user', content: 'I need help with AI integration' },
                    { role: 'assistant', content: 'I can help you with that!' }
                ]
            };
            
            try {
                const response = await fetch('https://amplifyx-chatbot.vercel.app/api/lead-submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': testData.sessionId
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `
                        <div class="result success">
                            <h3>‚úÖ Success!</h3>
                            <p>Reference Number: <strong>${result.referenceNumber}</strong></p>
                            <p>Lead ID: ${result.leadId}</p>
                            <p>Message: ${result.message}</p>
                            <pre>${JSON.stringify(testData, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="result error">
                            <h3>‚ùå Error</h3>
                            <p>${result.error || 'Unknown error'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Network Error</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }
        
        async function testWithStructuredData() {
            const resultDiv = document.getElementById('structured-result');
            resultDiv.innerHTML = '<div class="result">Processing AI response...</div>';
            
            // Simulate AI response with structured data
            const aiResponse = `
                Great! I've captured all your information. Let me confirm the details:
                
                - Name: John Doe
                - Email: john@example.com
                - Company: Tech Corp
                - Project: AI Automation
                
                Is everything correct?
                
                <!--STRUCTURED_DATA:{"name":"John Doe","email":"john@example.com","company":"Tech Corp","projectType":"AI Automation","timeline":"Next Quarter","budget":"50000","score":75}-->
            `;
            
            // Extract structured data
            const match = aiResponse.match(/<!--STRUCTURED_DATA:(.*?)-->/s);
            if (match) {
                const structuredData = JSON.parse(match[1]);
                
                const testData = {
                    sessionId: 'test-structured-' + Date.now(),
                    structuredData: structuredData,
                    conversation: [
                        { role: 'user', content: 'I need AI automation' },
                        { role: 'assistant', content: aiResponse }
                    ]
                };
                
                try {
                    const response = await fetch('https://amplifyx-chatbot.vercel.app/api/lead-submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Session-ID': testData.sessionId
                        },
                        body: JSON.stringify(testData)
                    });
                    
                    const result = await response.json();
                    
                    resultDiv.innerHTML = `
                        <div class="result ${result.success ? 'success' : 'error'}">
                            <h3>${result.success ? '‚úÖ Structured Data Processed!' : '‚ùå Error'}</h3>
                            <p>Reference: <strong>${result.referenceNumber || 'N/A'}</strong></p>
                            <p>Extracted Data:</p>
                            <pre>${JSON.stringify(structuredData, null, 2)}</pre>
                        </div>
                    `;
                } catch (error) {
                    resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
                }
            }
        }
        
        document.getElementById('test-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('form-result');
            
            const formData = {
                sessionId: 'form-test-' + Date.now(),
                structuredData: {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value || null,
                    company: document.getElementById('company').value || null,
                    projectType: document.getElementById('project').value || null,
                    score: 50
                },
                conversation: [
                    { role: 'user', content: 'Form submission test' }
                ]
            };
            
            try {
                const response = await fetch('https://amplifyx-chatbot.vercel.app/api/lead-submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-ID': formData.sessionId
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                resultDiv.innerHTML = `
                    <div class="result ${result.success ? 'success' : 'error'}">
                        <h3>${result.success ? '‚úÖ Submitted!' : '‚ùå Error'}</h3>
                        <p>Reference: <strong>${result.referenceNumber || 'N/A'}</strong></p>
                    </div>
                `;
                
                if (result.success) {
                    document.getElementById('test-form').reset();
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="result error">Error: ${error.message}</div>`;
            }
        });
    </script>
</body>
</html>