<!DOCTYPE html>
<html>
<head>
    <title>Test Live Chatbot with Supabase</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #0f0f1e;
            color: white;
        }
        h1 {
            color: #E94CFF;
            text-align: center;
        }
        .section {
            background: #1a1a2e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(123, 63, 242, 0.3);
        }
        .success {
            color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .error {
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .warning {
            color: #ffa502;
            background: rgba(255, 165, 2, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #7B3FF2, #E94CFF);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            opacity: 0.9;
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>üöÄ Live Chatbot Test (with Supabase)</h1>
    
    <div class="section">
        <h2>1. Configuration Status</h2>
        <div id="config-status"></div>
    </div>
    
    <div class="section">
        <h2>2. API Endpoints Test</h2>
        <div id="api-tests"></div>
        <button onclick="testAllAPIs()">Test All API Endpoints</button>
    </div>
    
    <div class="section">
        <h2>3. Load Test Chatbot</h2>
        <p>This will load the actual chatbot-secure.js with Supabase integration</p>
        <button onclick="loadChatbot()">Load Chatbot</button>
        <div id="chatbot-status"></div>
    </div>
    
    <div class="section">
        <h2>4. Console Output</h2>
        <pre id="console-output"></pre>
    </div>
    
    <!-- Chatbot container (hidden initially) -->
    <div id="chatbot-container" style="display: none;">
        <button id="chatbot-toggle" class="chatbot-toggle">
            <span class="chat-icon">üí¨</span>
            <span class="close-icon" style="display: none;">‚úñ</span>
            <span class="chat-badge" style="display: none;">1</span>
        </button>
        
        <div id="chatbot-window" class="chatbot-window">
            <div class="chatbot-header">
                <h3>AI Consultant</h3>
                <button id="chatbot-minimize">‚àí</button>
            </div>
            <div id="chatbot-messages" class="chatbot-messages"></div>
            <form id="chatbot-form" class="chatbot-form">
                <input type="text" id="chatbot-input" placeholder="Type your message..." required>
                <button type="submit">Send</button>
            </form>
            <div class="chatbot-footer">
                <a href="#" id="privacy-link">Privacy</a>
            </div>
        </div>
    </div>
    
    <!-- Add minimal chatbot styles -->
    <style>
        .chatbot-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7B3FF2, #E94CFF);
            border: none;
            cursor: pointer;
            font-size: 24px;
            z-index: 9999;
        }
        .chatbot-window {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 400px;
            height: 500px;
            background: #1a1a2e;
            border-radius: 12px;
            display: none;
            flex-direction: column;
            z-index: 9998;
            border: 1px solid rgba(123, 63, 242, 0.3);
        }
        .chatbot-window.active {
            display: flex;
        }
        .chatbot-header {
            padding: 15px;
            background: linear-gradient(135deg, #7B3FF2, #E94CFF);
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .chatbot-form {
            display: flex;
            padding: 15px;
            border-top: 1px solid rgba(123, 63, 242, 0.3);
        }
        .chatbot-form input {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(123, 63, 242, 0.5);
            border-radius: 8px;
            color: white;
            margin-right: 10px;
        }
        .chatbot-footer {
            text-align: center;
            padding: 10px;
            font-size: 12px;
        }
        .chat-message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-message.bot {
            background: rgba(255, 255, 255, 0.1);
            margin-right: 20%;
        }
        .chat-message.user {
            background: linear-gradient(135deg, #7B3FF2, #E94CFF);
            margin-left: 20%;
            text-align: right;
        }
    </style>
    
    <script>
    // Capture console output
    const consoleOutput = [];
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    
    console.log = function(...args) {
        originalLog.apply(console, args);
        consoleOutput.push(['LOG', ...args]);
        updateConsoleDisplay();
    };
    
    console.error = function(...args) {
        originalError.apply(console, args);
        consoleOutput.push(['ERROR', ...args]);
        updateConsoleDisplay();
    };
    
    console.warn = function(...args) {
        originalWarn.apply(console, args);
        consoleOutput.push(['WARN', ...args]);
        updateConsoleDisplay();
    };
    
    function updateConsoleDisplay() {
        const display = document.getElementById('console-output');
        display.textContent = consoleOutput.slice(-20).map(entry => {
            const [type, ...args] = entry;
            return `[${type}] ${args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg
            ).join(' ')}`;
        }).join('\n');
        display.scrollTop = display.scrollHeight;
    }
    
    // Check configuration
    function checkConfig() {
        const statusDiv = document.getElementById('config-status');
        
        // First load the config
        const script = document.createElement('script');
        script.src = 'js/config-public.js';
        script.onload = () => {
            let html = '';
            
            if (typeof window.AMPLIFYX_CONFIG !== 'undefined') {
                html += '<div class="success">‚úÖ AMPLIFYX_CONFIG loaded</div>';
                
                // Check endpoints
                if (window.AMPLIFYX_CONFIG.secureApiUrl) {
                    html += `<div class="success">‚úÖ Secure API URL: ${window.AMPLIFYX_CONFIG.secureApiUrl}</div>`;
                } else {
                    html += '<div class="error">‚ùå Secure API URL missing</div>';
                }
                
                if (window.AMPLIFYX_CONFIG.leadSubmitUrl) {
                    html += `<div class="success">‚úÖ Lead Submit URL: ${window.AMPLIFYX_CONFIG.leadSubmitUrl}</div>`;
                } else {
                    html += '<div class="error">‚ùå Lead Submit URL missing</div>';
                }
                
                if (window.AMPLIFYX_CONFIG.apiProxyUrl) {
                    html += `<div class="warning">‚ö†Ô∏è Legacy API URL: ${window.AMPLIFYX_CONFIG.apiProxyUrl}</div>`;
                }
            } else {
                html += '<div class="error">‚ùå AMPLIFYX_CONFIG not loaded</div>';
            }
            
            statusDiv.innerHTML = html;
        };
        document.head.appendChild(script);
    }
    
    // Test all API endpoints
    async function testAllAPIs() {
        const testsDiv = document.getElementById('api-tests');
        testsDiv.innerHTML = '<div class="warning">‚è≥ Testing APIs...</div>';
        
        const endpoints = [
            {
                name: 'Chat Secure API',
                url: 'https://amplifyx-chatbot.vercel.app/api/chat-secure',
                body: {
                    model: 'gpt-4o-mini',
                    messages: [
                        { role: 'system', content: 'Test' },
                        { role: 'user', content: 'Reply with OK' }
                    ],
                    max_tokens: 10
                }
            },
            {
                name: 'Lead Submit API',
                url: 'https://amplifyx-chatbot.vercel.app/api/lead-submit',
                body: {
                    test: true,
                    leadData: {
                        name: 'Test User',
                        email: 'test@example.com',
                        company: 'Test Company'
                    }
                }
            }
        ];
        
        let results = '';
        
        for (const endpoint of endpoints) {
            try {
                console.log(`Testing ${endpoint.name}...`);
                const response = await fetch(endpoint.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(endpoint.body)
                });
                
                const responseText = await response.text();
                console.log(`${endpoint.name} response:`, responseText);
                
                if (response.ok) {
                    results += `<div class="success">‚úÖ ${endpoint.name}: HTTP ${response.status}</div>`;
                } else {
                    results += `<div class="error">‚ùå ${endpoint.name}: HTTP ${response.status}</div>`;
                }
            } catch (error) {
                console.error(`${endpoint.name} error:`, error);
                results += `<div class="error">‚ùå ${endpoint.name}: ${error.message}</div>`;
            }
        }
        
        testsDiv.innerHTML = results;
    }
    
    // Load the actual chatbot
    function loadChatbot() {
        const statusDiv = document.getElementById('chatbot-status');
        statusDiv.innerHTML = '<div class="warning">‚è≥ Loading chatbot...</div>';
        
        // Load EmailJS first
        const emailScript = document.createElement('script');
        emailScript.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
        emailScript.onload = () => {
            console.log('EmailJS loaded');
            
            // Then load the chatbot
            const chatbotScript = document.createElement('script');
            chatbotScript.src = 'js/chatbot-secure.js';
            chatbotScript.onload = () => {
                console.log('Chatbot-secure.js loaded');
                statusDiv.innerHTML = '<div class="success">‚úÖ Chatbot loaded! Click the chat button in the bottom right.</div>';
                
                // Show the chatbot container
                document.getElementById('chatbot-container').style.display = 'block';
            };
            chatbotScript.onerror = (error) => {
                console.error('Failed to load chatbot:', error);
                statusDiv.innerHTML = '<div class="error">‚ùå Failed to load chatbot</div>';
            };
            document.body.appendChild(chatbotScript);
        };
        document.head.appendChild(emailScript);
    }
    
    // Initialize on load
    window.onload = function() {
        checkConfig();
        setTimeout(testAllAPIs, 1000); // Wait for config to load
    };
    </script>
</body>
</html>